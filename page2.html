 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
       
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a2e;
            color: #e6e6e6;
        }
       
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #16213e;
            image-rendering: pixelated;
        }
       
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10;
        }
       
        .btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            font-family: 'Press Start 2P', cursive;
        }
       
        .btn:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
       
        .health-bar {
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px 0;
        }
       
        .health-fill {
            height: 100%;
            border-radius: 10px;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
       
        .upgrade-card {
            background-color: #1a1a2e;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
       
        .upgrade-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #4CAF50;
        }
       
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(26, 26, 46, 0.7);
            border-radius: 5px;
        }
       
        .touch-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 5;
        }
       
        .joystick {
            width: 100px;
            height: 100px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
        }
       
        .joystick-knob {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 30px;
            left: 30px;
        }
       
        .action-btn {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
        }
       
        .pixel-art {
            image-rendering: pixelated;
        }
       
        .notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 20;
            animation: fadeOut 2s 1s forwards;
        }
       
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
   
    <!-- Loading Screen -->
    <div id="loadingScreen" class="game-screen">
        <h1 class="text-4xl mb-8 text-green-400">PIXEL ADVENTURE</h1>
        <div class="w-64 h-8 bg-gray-700 rounded-full overflow-hidden">
            <div id="loadingBar" class="h-full bg-green-500 w-0"></div>
        </div>
        <p id="loadingText" class="mt-4 text-gray-300">Loading assets...</p>
    </div>
   
    <!-- Main Menu -->
    <div id="mainMenu" class="game-screen hidden">
        <h1 class="text-5xl mb-8 text-green-400">PIXEL ADVENTURE</h1>
        <button id="startGameBtn" class="btn text-xl">START GAME</button>
        <button id="shopBtn" class="btn text-xl">SHOP</button>
        <button id="howToPlayBtn" class="btn text-xl">HOW TO PLAY</button>
    </div>
   
    <!-- How to Play -->
    <div id="howToPlay" class="game-screen hidden">
        <div class="bg-gray-900 p-8 rounded-lg max-w-2xl">
            <h2 class="text-3xl mb-6 text-green-400">HOW TO PLAY</h2>
            <div class="text-left mb-6">
                <p class="mb-4">• Use WASD or Arrow Keys to move your character</p>
                <p class="mb-4">• Your character automatically attacks nearby enemies</p>
                <p class="mb-4">• Dodge enemy attacks and collect coins</p>
                <p class="mb-4">• Level up to get upgrades between waves</p>
                <p class="mb-4">• Defeat bosses to progress to harder areas</p>
                <p class="mb-4">• Spend coins in the shop to unlock permanent upgrades</p>
            </div>
            <button id="backToMenuBtn" class="btn">BACK TO MENU</button>
        </div>
    </div>
   
    <!-- Shop Screen -->
    <div id="shopScreen" class="game-screen hidden">
        <div class="bg-gray-900 p-8 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl text-green-400">SHOP</h2>
                <div class="text-xl">
                    Coins: <span id="shopCoins" class="text-yellow-400">0</span>
                </div>
            </div>
           
            <div class="mb-8">
                <h3 class="text-xl mb-4 text-green-300">WEAPONS</h3>
                <div id="weaponsShop" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Weapons will be added here by JavaScript -->
                </div>
            </div>
           
            <div class="mb-8">
                <h3 class="text-xl mb-4 text-green-300">ARMOR</h3>
                <div id="armorShop" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Armor will be added here by JavaScript -->
                </div>
            </div>
           
            <div class="mb-8">
                <h3 class="text-xl mb-4 text-green-300">PETS</h3>
                <div id="petsShop" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Pets will be added here by JavaScript -->
                </div>
            </div>
           
            <div class="mb-8">
                <h3 class="text-xl mb-4 text-green-300">SKINS</h3>
                <div id="skinsShop" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Skins will be added here by JavaScript -->
                </div>
            </div>
           
            <button id="backToMenuFromShopBtn" class="btn w-full">BACK TO MENU</button>
        </div>
    </div>
   
    <!-- Upgrade Screen -->
    <div id="upgradeScreen" class="game-screen hidden">
        <div class="bg-gray-900 p-8 rounded-lg max-w-2xl">
            <h2 class="text-3xl mb-6 text-green-400">LEVEL UP!</h2>
            <p class="mb-6">Choose an upgrade:</p>
            <div id="upgradeOptions" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Upgrade options will be added here by JavaScript -->
            </div>
        </div>
    </div>
   
    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="game-screen hidden">
        <div class="bg-gray-900 p-8 rounded-lg max-w-2xl">
            <h2 class="text-4xl mb-6 text-red-500">GAME OVER</h2>
            <div class="text-xl mb-6">
                <p>Wave: <span id="finalWave" class="text-green-400">0</span></p>
                <p>Enemies Defeated: <span id="finalEnemies" class="text-green-400">0</span></p>
                <p>Coins Collected: <span id="finalCoins" class="text-yellow-400">0</span></p>
            </div>
            <button id="restartGameBtn" class="btn mb-4">PLAY AGAIN</button>
            <button id="goToShopBtn" class="btn">SHOP</button>
        </div>
    </div>
   
    <!-- HUD Elements -->
    <div id="gameHUD" class="absolute top-0 left-0 p-4 hidden">
        <div class="flex items-center mb-2">
            <div class="w-32 h-6 bg-gray-700 rounded-full overflow-hidden mr-4">
                <div id="healthBar" class="h-full bg-green-500 rounded-full" style="width: 100%"></div>
            </div>
            <span id="healthText" class="text-white">100/100</span>
        </div>
       
        <div class="flex items-center mb-2">
            <div class="w-32 h-6 bg-gray-700 rounded-full overflow-hidden mr-4">
                <div id="xpBar" class="h-full bg-blue-500 rounded-full" style="width: 0%"></div>
            </div>
            <span id="levelText" class="text-white">Lvl: 1</span>
        </div>
       
        <div class="flex items-center mb-2">
            <span class="text-white mr-2">Wave:</span>
            <span id="waveText" class="text-green-400">1</span>
        </div>
       
        <div class="flex items-center">
            <span class="text-white mr-2">Coins:</span>
            <span id="coinText" class="text-yellow-400">0</span>
        </div>
       
        <div id="weaponInfo" class="mt-4 p-2 bg-gray-800 rounded">
            <p class="text-sm">Weapon: <span id="currentWeapon" class="text-green-400">Basic Gun</span></p>
            <p class="text-sm">Damage: <span id="weaponDamage" class="text-red-400">10</span></p>
        </div>
    </div>
   
    <!-- Touch Controls (for mobile) -->
    <div id="touchControls" class="touch-controls hidden">
        <div class="joystick" id="movementJoystick">
            <div class="joystick-knob"></div>
        </div>
        <div class="action-btn" id="actionButton">A</div>
    </div>
   
    <script>
        // Game Constants
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        const PLAYER_SIZE = 32;
        const ENEMY_SIZE = 32;
        const PROJECTILE_SIZE = 8;
        const COIN_SIZE = 16;
       
        // Game Variables
        let canvas, ctx;
        let gameRunning = false;
        let lastTime = 0;
        let deltaTime = 0;
        let player;
        let enemies = [];
        let projectiles = [];
        let coins = [];
        let particles = [];
        let currentWave = 1;
        let enemiesDefeated = 0;
        let coinsCollected = 0;
        let totalCoins = 0;
        let playerLevel = 1;
        let playerXP = 0;
        let xpToNextLevel = 100;
        let gameTime = 0;
        let keys = {};
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoveX = 0;
        let touchMoveY = 0;
        let isTouchActive = false;
       
        // Game State
        const GAME_STATE = {
            LOADING: 0,
            MENU: 1,
            PLAYING: 2,
            UPGRADING: 3,
            GAME_OVER: 4,
            SHOP: 5,
            HOW_TO_PLAY: 6
        };
       
        let currentGameState = GAME_STATE.LOADING;
       
        // Player Data
        const playerData = {
            maxHealth: 100,
            health: 100,
            speed: 3,
            damageMultiplier: 1,
            defense: 0,
            healthRegen: 0,
            critChance: 0.05,
            critMultiplier: 1.5,
            coinMultiplier: 1,
            xpMultiplier: 1,
            currentWeapon: 'basicGun',
            currentSkin: 'default',
            currentPet: null,
            unlockedWeapons: ['basicGun'],
            unlockedSkins: ['default'],
            unlockedPets: []
        };
       
        // Weapons Data
        const weapons = {
            basicGun: {
                name: "Basic Gun",
                damage: 10,
                attackSpeed: 0.5,
                range: 300,
                projectileSpeed: 8,
                projectileSize: 8,
                color: "#00ff00",
                description: "Standard issue firearm",
                unlocked: true,
                price: 0
            },
            shotgun: {
                name: "Shotgun",
                damage: 6,
                attackSpeed: 1,
                range: 200,
                projectileSpeed: 10,
                projectileSize: 6,
                spread: 5,
                projectiles: 5,
                color: "#ff6600",
                description: "Fires multiple pellets in a spread",
                unlocked: false,
                price: 500
            },
            laserGun: {
                name: "Laser Gun",
                damage: 15,
                attackSpeed: 0.8,
                range: 350,
                projectileSpeed: 12,
                projectileSize: 4,
                color: "#ff00ff",
                description: "High-speed energy projectiles",
                unlocked: false,
                price: 800
            },
            flameThrower: {
                name: "Flame Thrower",
                damage: 4,
                attackSpeed: 0.2,
                range: 150,
                projectileSpeed: 5,
                projectileSize: 10,
                color: "#ff3300",
                description: "Continuous stream of fire",
                unlocked: false,
                price: 1000
            }
        };
       
        // Armor Data
        const armor = {
            lightArmor: {
                name: "Light Armor",
                defense: 0.1,
                speedBonus: 0.2,
                healthBonus: 0,
                description: "Increases movement speed slightly",
                unlocked: false,
                price: 300
            },
            mediumArmor: {
                name: "Medium Armor",
                defense: 0.2,
                speedBonus: 0,
                healthBonus: 20,
                description: "Balanced protection",
                unlocked: false,
                price: 600
            },
            heavyArmor: {
                name: "Heavy Armor",
                defense: 0.3,
                speedBonus: -0.1,
                healthBonus: 50,
                description: "Maximum protection but slower",
                unlocked: false,
                price: 900
            }
        };
       
        // Pets Data
        const pets = {
            healingFairy: {
                name: "Healing Fairy",
                type: "healing",
                amount: 1,
                interval: 3,
                description: "Heals you periodically",
                unlocked: false,
                price: 700
            },
            attackDrone: {
                name: "Attack Drone",
                type: "attack",
                damage: 5,
                attackSpeed: 1,
                range: 200,
                description: "Attacks enemies automatically",
                unlocked: false,
                price: 1000
            },
            coinGoblin: {
                name: "Coin Goblin",
                type: "coin",
                multiplier: 0.2,
                description: "Increases coin drops",
                unlocked: false,
                price: 800
            }
        };
       
        // Skins Data
        const skins = {
            default: {
                name: "Default",
                color: "#4CAF50",
                unlocked: true,
                price: 0
            },
            ninja: {
                name: "Ninja",
                color: "#333333",
                unlocked: false,
                price: 400
            },
            knight: {
                name: "Knight",
                color: "#cccccc",
                unlocked: false,
                price: 400
            },
            mage: {
                name: "Mage",
                color: "#9900ff",
                unlocked: false,
                price: 400
            }
        };
       
        // Upgrades Data
        const upgrades = {
            healthUp: {
                name: "Health Increase",
                description: "Increases max health by 20",
                apply: () => {
                    playerData.maxHealth += 20;
                    playerData.health += 20;
                    updateHealthBar();
                }
            },
            damageUp: {
                name: "Damage Increase",
                description: "Increases damage by 15%",
                apply: () => {
                    playerData.damageMultiplier += 0.15;
                }
            },
            speedUp: {
                name: "Speed Increase",
                description: "Increases movement speed by 10%",
                apply: () => {
                    playerData.speed *= 1.1;
                }
            },
            healthRegen: {
                name: "Health Regen",
                description: "Regenerates 1 health per second",
                apply: () => {
                    playerData.healthRegen += 1;
                }
            },
            critChance: {
                name: "Critical Chance",
                description: "Increases critical hit chance by 5%",
                apply: () => {
                    playerData.critChance += 0.05;
                }
            },
            critDamage: {
                name: "Critical Damage",
                description: "Increases critical damage by 20%",
                apply: () => {
                    playerData.critMultiplier += 0.2;
                }
            }
        };
       
        // Enemy Types
        const enemyTypes = {
            basic: {
                health: 30,
                speed: 1.5,
                damage: 10,
                color: "#ff0000",
                size: 32,
                xp: 20,
                coinDrop: 10
            },
            fast: {
                health: 20,
                speed: 3,
                damage: 8,
                color: "#ffff00",
                size: 28,
                xp: 15,
                coinDrop: 8
            },
            tank: {
                health: 60,
                speed: 1,
                damage: 15,
                color: "#0000ff",
                size: 40,
                xp: 30,
                coinDrop: 15
            },
            boss: {
                health: 200,
                speed: 1.2,
                damage: 25,
                color: "#990000",
                size: 64,
                xp: 100,
                coinDrop: 50
            }
        };
       
        // Initialize the game
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
           
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
           
            // Set up event listeners
            window.addEventListener('keydown', (e) => {
                keys[e.key] = true;
            });
           
            window.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });
           
            // Touch controls
            const joystick = document.getElementById('movementJoystick');
            const joystickKnob = joystick.querySelector('.joystick-knob');
           
            joystick.addEventListener('touchstart', (e) => {
                isTouchActive = true;
                const rect = joystick.getBoundingClientRect();
                touchStartX = rect.left + rect.width / 2;
                touchStartY = rect.top + rect.height / 2;
                e.preventDefault();
            });
           
            joystick.addEventListener('touchmove', (e) => {
                if (isTouchActive) {
                    touchMoveX = e.touches[0].clientX - touchStartX;
                    touchMoveY = e.touches[0].clientY - touchStartY;
                   
                    // Limit joystick movement to the joystick area
                    const distance = Math.sqrt(touchMoveX * touchMoveX + touchMoveY * touchMoveY);
                    const maxDistance = joystick.offsetWidth / 2;
                   
                    if (distance > maxDistance) {
                        touchMoveX = (touchMoveX / distance) * maxDistance;
                        touchMoveY = (touchMoveY / distance) * maxDistance;
                    }
                   
                    // Update joystick knob position
                    joystickKnob.style.transform = `translate(${touchMoveX}px, ${touchMoveY}px)`;
                    e.preventDefault();
                }
            });
           
            joystick.addEventListener('touchend', () => {
                isTouchActive = false;
                touchMoveX = 0;
                touchMoveY = 0;
                joystickKnob.style.transform = 'translate(30px, 30px)';
            });
           
            // Check if touch device
            if ('ontouchstart' in window) {
                document.getElementById('touchControls').classList.remove('hidden');
            }
           
            // Set up UI event listeners
            document.getElementById('startGameBtn').addEventListener('click', () => {
                startGame();
            });
           
            document.getElementById('shopBtn').addEventListener('click', () => {
                showShop();
            });
           
            document.getElementById('howToPlayBtn').addEventListener('click', () => {
                showHowToPlay();
            });
           
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                backToMenu();
            });
           
            document.getElementById('backToMenuFromShopBtn').addEventListener('click', () => {
                backToMenu();
            });
           
            document.getElementById('restartGameBtn').addEventListener('click', () => {
                startGame();
            });
           
            document.getElementById('goToShopBtn').addEventListener('click', () => {
                showShop();
            });
           
            // Simulate loading
            simulateLoading();
        }
       
        // Simulate loading assets
        function simulateLoading() {
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 5;
                document.getElementById('loadingBar').style.width = `${progress}%`;
               
                if (progress >= 20) {
                    document.getElementById('loadingText').textContent = "Loading sprites...";
                }
                if (progress >= 50) {
                    document.getElementById('loadingText').textContent = "Loading sounds...";
                }
                if (progress >= 80) {
                    document.getElementById('loadingText').textContent = "Almost there...";
                }
               
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    showMainMenu();
                }
            }, 100);
        }
       
        // Show main menu
        function showMainMenu() {
            currentGameState = GAME_STATE.MENU;
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('gameHUD').classList.add('hidden');
        }
       
        // Show how to play screen
        function showHowToPlay() {
            currentGameState = GAME_STATE.HOW_TO_PLAY;
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('howToPlay').classList.remove('hidden');
        }
       
        // Back to menu from other screens
        function backToMenu() {
            currentGameState = GAME_STATE.MENU;
            document.getElementById('howToPlay').classList.add('hidden');
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
        }
       
        // Show shop screen
        function showShop() {
            currentGameState = GAME_STATE.SHOP;
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('shopScreen').classList.remove('hidden');
           
            // Update coins display
            document.getElementById('shopCoins').textContent = totalCoins;
           
            // Populate weapons shop
            const weaponsShop = document.getElementById('weaponsShop');
            weaponsShop.innerHTML = '';
           
            for (const [key, weapon] of Object.entries(weapons)) {
                const weaponCard = document.createElement('div');
                weaponCard.className = 'upgrade-card';
               
                const owned = playerData.unlockedWeapons.includes(key);
               
                weaponCard.innerHTML = `
                    <h3 class="text-lg mb-2">${weapon.name}</h3>
                    <p class="text-sm mb-2">Damage: ${weapon.damage}</p>
                    <p class="text-sm mb-2">Speed: ${1/weapon.attackSpeed}/s</p>
                    <p class="text-sm mb-2">Range: ${weapon.range}</p>
                    <p class="text-xs mb-3">${weapon.description}</p>
                    ${owned ?
                        '<p class="text-green-400 mb-2">OWNED</p>' :
                        `<button class="btn buy-btn w-full" data-type="weapon" data-id="${key}" ${totalCoins < weapon.price ? 'disabled' : ''}>
                            Buy (${weapon.price} coins)
                        </button>`
                    }
                `;
               
                weaponsShop.appendChild(weaponCard);
            }
           
            // Populate armor shop
            const armorShop = document.getElementById('armorShop');
            armorShop.innerHTML = '';
           
            for (const [key, armorItem] of Object.entries(armor)) {
                const armorCard = document.createElement('div');
                armorCard.className = 'upgrade-card';
               
                const owned = playerData.defense === armorItem.defense;
               
                armorCard.innerHTML = `
                    <h3 class="text-lg mb-2">${armorItem.name}</h3>
                    <p class="text-sm mb-2">Defense: ${armorItem.defense * 100}%</p>
                    ${armorItem.speedBonus !== 0 ? `<p class="text-sm mb-2">Speed: ${armorItem.speedBonus > 0 ? '+' : ''}${armorItem.speedBonus * 100}%</p>` : ''}
                    ${armorItem.healthBonus > 0 ? `<p class="text-sm mb-2">+${armorItem.healthBonus} Health</p>` : ''}
                    <p class="text-xs mb-3">${armorItem.description}</p>
                    ${owned ?
                        '<p class="text-green-400 mb-2">EQUIPPED</p>' :
                        `<button class="btn buy-btn w-full" data-type="armor" data-id="${key}" ${totalCoins < armorItem.price ? 'disabled' : ''}>
                            Buy (${armorItem.price} coins)
                        </button>`
                    }
                `;
               
                armorShop.appendChild(armorCard);
            }
           
            // Populate pets shop
            const petsShop = document.getElementById('petsShop');
            petsShop.innerHTML = '';
           
            for (const [key, pet] of Object.entries(pets)) {
                const petCard = document.createElement('div');
                petCard.className = 'upgrade-card';
               
                const owned = playerData.unlockedPets.includes(key);
               
                petCard.innerHTML = `
                    <h3 class="text-lg mb-2">${pet.name}</h3>
                    <p class="text-sm mb-2">Type: ${pet.type}</p>
                    ${pet.type === 'healing' ? `<p class="text-sm mb-2">Heal: ${pet.amount} HP every ${pet.interval}s</p>` : ''}
                    ${pet.type === 'attack' ? `<p class="text-sm mb-2">Damage: ${pet.damage}</p>` : ''}
                    ${pet.type === 'coin' ? `<p class="text-sm mb-2">Bonus: +${pet.multiplier * 100}% coins</p>` : ''}
                    <p class="text-xs mb-3">${pet.description}</p>
                    ${owned ?
                        '<p class="text-green-400 mb-2">OWNED</p>' :
                        `<button class="btn buy-btn w-full" data-type="pet" data-id="${key}" ${totalCoins < pet.price ? 'disabled' : ''}>
                            Buy (${pet.price} coins)
                        </button>`
                    }
                `;
               
                petsShop.appendChild(petCard);
            }
           
            // Populate skins shop
            const skinsShop = document.getElementById('skinsShop');
            skinsShop.innerHTML = '';
           
            for (const [key, skin] of Object.entries(skins)) {
                const skinCard = document.createElement('div');
                skinCard.className = 'upgrade-card';
               
                const owned = playerData.unlockedSkins.includes(key);
               
                skinCard.innerHTML = `
                    <div class="w-16 h-16 mx-auto mb-2 rounded-full" style="background-color: ${skin.color};"></div>
                    <h3 class="text-lg mb-2">${skin.name}</h3>
                    ${owned ?
                        `<p class="text-green-400 mb-2">${playerData.currentSkin === key ? 'EQUIPPED' : 'OWNED'}</p>` :
                        `<button class="btn buy-btn w-full" data-type="skin" data-id="${key}" ${totalCoins < skin.price ? 'disabled' : ''}>
                            Buy (${skin.price} coins)
                        </button>`
                    }
                `;
               
                skinsShop.appendChild(skinCard);
            }
           
            // Add event listeners to buy buttons
            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.getAttribute('data-type');
                    const id = e.target.getAttribute('data-id');
                    buyItem(type, id);
                });
            });
        }
       
        // Buy item from shop
        function buyItem(type, id) {
            let price = 0;
           
            switch (type) {
                case 'weapon':
                    price = weapons[id].price;
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        playerData.unlockedWeapons.push(id);
                        showNotification(`Unlocked ${weapons[id].name}!`);
                    }
                    break;
                   
                case 'armor':
                    price = armor[id].price;
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        playerData.defense = armor[id].defense;
                        playerData.speed = 3 * (1 + armor[id].speedBonus);
                        playerData.maxHealth = 100 + armor[id].healthBonus;
                        playerData.health = playerData.maxHealth;
                        updateHealthBar();
                        showNotification(`Equipped ${armor[id].name}!`);
                    }
                    break;
                   
                case 'pet':
                    price = pets[id].price;
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        playerData.unlockedPets.push(id);
                        playerData.currentPet = id;
                        showNotification(`Unlocked ${pets[id].name} pet!`);
                    }
                    break;
                   
                case 'skin':
                    price = skins[id].price;
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        playerData.unlockedSkins.push(id);
                        playerData.currentSkin = id;
                        showNotification(`Unlocked ${skins[id].name} skin!`);
                    }
                    break;
            }
           
            // Update shop display
            document.getElementById('shopCoins').textContent = totalCoins;
            showShop();
        }
       
        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
           
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
       
        // Start the game
        function startGame() {
            // Reset game state
            currentGameState = GAME_STATE.PLAYING;
            currentWave = 1;
            enemiesDefeated = 0;
            coinsCollected = 0;
            playerLevel = 1;
            playerXP = 0;
            xpToNextLevel = 100;
            gameTime = 0;
           
            // Reset player
            playerData.health = playerData.maxHealth;
            playerData.currentWeapon = 'basicGun';
           
            // Clear all entities
            enemies = [];
            projectiles = [];
            coins = [];
            particles = [];
           
            // Set up player
            player = {
                x: CANVAS_WIDTH / 2,
                y: CANVAS_HEIGHT / 2,
                size: PLAYER_SIZE,
                lastAttack: 0
            };
           
            // Show HUD
            document.getElementById('gameHUD').classList.remove('hidden');
            updateHealthBar();
            document.getElementById('levelText').textContent = `Lvl: ${playerLevel}`;
            document.getElementById('xpBar').style.width = '0%';
            document.getElementById('waveText').textContent = currentWave;
            document.getElementById('coinText').textContent = coinsCollected;
            document.getElementById('currentWeapon').textContent = weapons[playerData.currentWeapon].name;
            document.getElementById('weaponDamage').textContent = weapons[playerData.currentWeapon].damage * playerData.damageMultiplier;
           
            // Hide all screens
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('upgradeScreen').classList.add('hidden');
           
            // Start game loop
            gameRunning = true;
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
           
            // Spawn first wave
            spawnWave();
        }
       
        // Game loop
        function gameLoop(time) {
            if (!gameRunning) return;
           
            deltaTime = (time - lastTime) / 1000;
            lastTime = time;
            gameTime += deltaTime;
           
            // Clear canvas
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
           
            // Update and draw based on game state
            switch (currentGameState) {
                case GAME_STATE.PLAYING:
                    updateGame();
                    drawGame();
                    break;
                   
                case GAME_STATE.UPGRADING:
                    drawGame();
                    break;
                   
                case GAME_STATE.GAME_OVER:
                    break;
            }
           
            requestAnimationFrame(gameLoop);
        }
       
        // Update game state
        function updateGame() {
            // Update player
            updatePlayer();
           
            // Update enemies
            updateEnemies();
           
            // Update projectiles
            updateProjectiles();
           
            // Update coins
            updateCoins();
           
            // Update particles
            updateParticles();
           
            // Check for level up
            if (playerXP >= xpToNextLevel) {
                levelUp();
            }
           
            // Check for wave completion
            if (enemies.length === 0) {
                currentWave++;
                document.getElementById('waveText').textContent = currentWave;
                spawnWave();
               
                // Every 5 waves, spawn a boss
                if (currentWave % 5 === 0) {
                    spawnBoss();
                }
            }
           
            // Check for game over
            if (playerData.health <= 0) {
                gameOver();
            }
        }
       
        // Draw game
        function drawGame() {
            // Draw background
            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
           
            // Draw grid (for visual reference)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
           
            for (let x = 0; x < CANVAS_WIDTH; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, CANVAS_HEIGHT);
                ctx.stroke();
            }
           
            for (let y = 0; y < CANVAS_HEIGHT; y += 40) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(CANVAS_WIDTH, y);
                ctx.stroke();
            }
           
            // Draw coins
            for (const coin of coins) {
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(coin.x, coin.y, coin.size / 2, 0, Math.PI * 2);
                ctx.fill();
               
                // Draw $ symbol
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('$', coin.x, coin.y);
            }
           
            // Draw enemies
            for (const enemy of enemies) {
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.size / 2, 0, Math.PI * 2);
                ctx.fill();
               
                // Draw health bar
                const healthBarWidth = 30;
                const healthBarHeight = 5;
                const healthPercentage = enemy.health / enemy.maxHealth;
               
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(
                    enemy.x - healthBarWidth / 2,
                    enemy.y - enemy.size / 2 - 10,
                    healthBarWidth,
                    healthBarHeight
                );
               
                ctx.fillStyle = healthPercentage > 0.6 ? '#00ff00' :
                                healthPercentage > 0.3 ? '#ffff00' : '#ff0000';
                ctx.fillRect(
                    enemy.x - healthBarWidth / 2,
                    enemy.y - enemy.size / 2 - 10,
                    healthBarWidth * healthPercentage,
                    healthBarHeight
                );
            }
           
            // Draw projectiles
            for (const projectile of projectiles) {
                ctx.fillStyle = projectile.color;
                ctx.beginPath();
                ctx.arc(projectile.x, projectile.y, projectile.size / 2, 0, Math.PI * 2);
                ctx.fill();
            }
           
            // Draw particles
            for (const particle of particles) {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = particle.life / particle.maxLife;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
           
            // Draw player
            ctx.fillStyle = skins[playerData.currentSkin].color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
            ctx.fill();
           
            // Draw weapon
            const weapon = weapons[playerData.currentWeapon];
            ctx.fillStyle = weapon.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, weapon.projectileSize * 0.8, 0, Math.PI * 2);
            ctx.fill();
           
            // Draw pet if equipped
            if (playerData.currentPet) {
                const pet = pets[playerData.currentPet];
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(
                    player.x + Math.cos(gameTime * 3) * 40,
                    player.y + Math.sin(gameTime * 3) * 40,
                    10,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
               
                // Draw pet type indicator
                ctx.fillStyle = '#000';
                ctx.font = 'bold 8px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
               
                let symbol = '';
                switch (pet.type) {
                    case 'healing': symbol = '+'; break;
                    case 'attack': symbol = '⚔'; break;
                    case 'coin': symbol = '$'; break;
                }
               
                ctx.fillText(
                    symbol,
                    player.x + Math.cos(gameTime * 3) * 40,
                    player.y + Math.sin(gameTime * 3) * 40
                );
            }
        }
       
        // Update player
        function updatePlayer() {
            // Movement
            let moveX = 0;
            let moveY = 0;
           
            // Keyboard controls
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) moveX -= 1;
            if (keys['ArrowRight'] || keys['d'] || keys['D']) moveX += 1;
            if (keys['ArrowUp'] || keys['w'] || keys['W']) moveY -= 1;
            if (keys['ArrowDown'] || keys['s'] || keys['S']) moveY += 1;
           
            // Touch controls
            if (isTouchActive) {
                const deadZone = 10;
                const touchDistance = Math.sqrt(touchMoveX * touchMoveX + touchMoveY * touchMoveY);
               
                if (touchDistance > deadZone) {
                    moveX = touchMoveX / touchDistance;
                    moveY = touchMoveY / touchDistance;
                }
            }
           
            // Normalize diagonal movement
            if (moveX !== 0 && moveY !== 0) {
                const length = Math.sqrt(moveX * moveX + moveY * moveY);
                moveX /= length;
                moveY /= length;
            }
           
            // Apply movement
            player.x += moveX * playerData.speed;
            player.y += moveY * playerData.speed;
           
            // Keep player within bounds
            player.x = Math.max(player.size / 2, Math.min(CANVAS_WIDTH - player.size / 2, player.x));
            player.y = Math.max(player.size / 2, Math.min(CANVAS_HEIGHT - player.size / 2, player.y));
           
            // Auto-attack
            const weapon = weapons[playerData.currentWeapon];
            if (gameTime - player.lastAttack >= weapon.attackSpeed) {
                attackEnemies();
                player.lastAttack = gameTime;
            }
           
            // Health regen
            if (playerData.healthRegen > 0) {
                playerData.health = Math.min(
                    playerData.maxHealth,
                    playerData.health + playerData.healthRegen * deltaTime
                );
                updateHealthBar();
            }
           
            // Pet effects
            if (playerData.currentPet) {
                const pet = pets[playerData.currentPet];
               
                // Healing pet
                if (pet.type === 'healing' && gameTime % pet.interval < deltaTime) {
                    playerData.health = Math.min(
                        playerData.maxHealth,
                        playerData.health + pet.amount
                    );
                    updateHealthBar();
                   
                    // Show healing effect
                    createParticles(
                        player.x,
                        player.y,
                        5,
                        '#00ff00',
                        10,
                        1,
                        100,
                        Math.PI * 2
                    );
                }
            }
        }
       
        // Attack enemies
        function attackEnemies() {
            const weapon = weapons[playerData.currentWeapon];
           
            // Find closest enemy
            let closestEnemy = null;
            let closestDistance = Infinity;
           
            for (const enemy of enemies) {
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
               
                if (distance < closestDistance && distance <= weapon.range) {
                    closestDistance = distance;
                    closestEnemy = enemy;
                }
            }
           
            if (closestEnemy) {
                // Calculate direction to enemy
                const dx = closestEnemy.x - player.x;
                const dy = closestEnemy.y - player.y;
                const angle = Math.atan2(dy, dx);
               
                // Check for critical hit
                const isCritical = Math.random() < playerData.critChance;
                const damage = weapon.damage * playerData.damageMultiplier *
                              (isCritical ? playerData.critMultiplier : 1);
               
                // Create projectile
                if (weapon.spread) {
                    // Shotgun-style spread
                    for (let i = 0; i < weapon.projectiles; i++) {
                        const spreadAngle = angle + (Math.random() - 0.5) * weapon.spread * Math.PI / 180;
                       
                        projectiles.push({
                            x: player.x,
                            y: player.y,
                            size: weapon.projectileSize,
                            speed: weapon.projectileSpeed,
                            angle: spreadAngle,
                            damage: damage / weapon.projectiles,
                            range: weapon.range,
                            color: weapon.color,
                            distance: 0,
                            isCritical: isCritical
                        });
                    }
                } else {
                    // Single projectile
                    projectiles.push({
                        x: player.x,
                        y: player.y,
                        size: weapon.projectileSize,
                        speed: weapon.projectileSpeed,
                        angle: angle,
                        damage: damage,
                        range: weapon.range,
                        color: weapon.color,
                        distance: 0,
                        isCritical: isCritical
                    });
                }
               
                // Create muzzle flash particles
                createParticles(
                    player.x,
                    player.y,
                    5,
                    weapon.color,
                    10,
                    2,
                    0.2,
                    Math.PI / 4,
                    angle
                );
            }
        }
       
        // Update enemies
        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
               
                // Move towards player
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
               
                if (distance > 0) {
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;
                }
               
                // Check collision with player
                if (distance < (player.size / 2 + enemy.size / 2)) {
                    // Damage player
                    const damage = enemy.damage * (1 - playerData.defense);
                    playerData.health -= damage * deltaTime;
                    updateHealthBar();
                   
                    // Create hit particles
                    createParticles(
                        player.x,
                        player.y,
                        3,
                        '#ff0000',
                        10,
                        1,
                        0.5,
                        Math.PI * 2
                    );
                }
               
                // Check if enemy is dead
                if (enemy.health <= 0) {
                    // Drop coin
                    coins.push({
                        x: enemy.x,
                        y: enemy.y,
                        size: COIN_SIZE,
                        value: enemy.coinDrop * playerData.coinMultiplier *
                               (playerData.currentPet && pets[playerData.currentPet].type === 'coin' ?
                                (1 + pets[playerData.currentPet].multiplier) : 1)
                    });
                   
                    // Add XP
                    playerXP += enemy.xp * playerData.xpMultiplier;
                    document.getElementById('xpBar').style.width = `${Math.min(100, (playerXP / xpToNextLevel) * 100)}%`;
                   
                    // Create death particles
                    createParticles(
                        enemy.x,
                        enemy.y,
                        10,
                        enemy.color,
                        20,
                        3,
                        1,
                        Math.PI * 2
                    );
                   
                    // Remove enemy
                    enemies.splice(i, 1);
                    enemiesDefeated++;
                }
            }
        }
       
        // Update projectiles
        function updateProjectiles() {
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const projectile = projectiles[i];
               
                // Move projectile
                projectile.x += Math.cos(projectile.angle) * projectile.speed;
                projectile.y += Math.sin(projectile.angle) * projectile.speed;
                projectile.distance += projectile.speed;
               
                // Check if projectile is out of range
                if (projectile.distance >= projectile.range) {
                    projectiles.splice(i, 1);
                    continue;
                }
               
                // Check collision with enemies
                for (let j = 0; j < enemies.length; j++) {
                    const enemy = enemies[j];
                    const dx = projectile.x - enemy.x;
                    const dy = projectile.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                   
                    if (distance < (projectile.size / 2 + enemy.size / 2)) {
                        // Damage enemy
                        enemy.health -= projectile.damage;
                       
                        // Show hit effect
                        createParticles(
                            projectile.x,
                            projectile.y,
                            3,
                            projectile.isCritical ? '#ffff00' : projectile.color,
                            10,
                            projectile.isCritical ? 2 : 1,
                            0.5,
                            Math.PI * 2
                        );
                       
                        // Remove projectile
                        projectiles.splice(i, 1);
                        break;
                    }
                }
            }
        }
       
        // Update coins
        function updateCoins() {
            for (let i = coins.length - 1; i >= 0; i--) {
                const coin = coins[i];
               
                // Check collision with player
                const dx = player.x - coin.x;
                const dy = player.y - coin.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
               
                if (distance < (player.size / 2 + coin.size / 2)) {
                    // Collect coin
                    coinsCollected += coin.value;
                    totalCoins += coin.value;
                    document.getElementById('coinText').textContent = Math.floor(coinsCollected);
                   
                    // Create collection particles
                    createParticles(
                        coin.x,
                        coin.y,
                        5,
                        '#ffd700',
                        10,
                        1,
                        0.5,
                        Math.PI * 2
                    );
                   
                    // Remove coin
                    coins.splice(i, 1);
                }
            }
        }
       
        // Update particles
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
               
                // Update particle
                particle.x += Math.cos(particle.angle) * particle.speed;
                particle.y += Math.sin(particle.angle) * particle.speed;
                particle.life -= deltaTime;
               
                // Remove dead particles
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
       
        // Create particles
        function createParticles(x, y, count, color, size, speed, life, angleRange, baseAngle = 0) {
            for (let i = 0; i < count; i++) {
                const angle = baseAngle + (Math.random() - 0.5) * angleRange;
               
                particles.push({
                    x: x,
                    y: y,
                    size: size * Math.random(),
                    speed: speed * Math.random(),
                    angle: angle,
                    color: color,
                    life: life * Math.random(),
                    maxLife: life
                });
            }
        }
       
        // Spawn wave of enemies
        function spawnWave() {
            const enemyCount = 5 + currentWave * 2;
           
            for (let i = 0; i < enemyCount; i++) {
                let enemyType;
                const rand = Math.random();
               
                if (currentWave < 3) {
                    enemyType = 'basic';
                } else if (currentWave < 6) {
                    enemyType = rand < 0.7 ? 'basic' : 'fast';
                } else if (currentWave < 10) {
                    if (rand < 0.5) enemyType = 'basic';
                    else if (rand < 0.8) enemyType = 'fast';
                    else enemyType = 'tank';
                } else {
                    if (rand < 0.4) enemyType = 'basic';
                    else if (rand < 0.7) enemyType = 'fast';
                    else enemyType = 'tank';
                }
               
                spawnEnemy(enemyType);
            }
        }
       
        // Spawn boss
        function spawnBoss() {
            for (let i = 0; i < Math.floor(currentWave / 5); i++) {
                spawnEnemy('boss');
            }
        }
       
        // Spawn enemy
        function spawnEnemy(type) {
            const enemyData = enemyTypes[type];
           
            // Find spawn position (not too close to player)
            let x, y;
            let attempts = 0;
            const minDistance = 200;
           
            do {
                x = Math.random() * (CANVAS_WIDTH - enemyData.size) + enemyData.size / 2;
                y = Math.random() * (CANVAS_HEIGHT - enemyData.size) + enemyData.size / 2;
                attempts++;
               
                if (attempts > 100) break; // Prevent infinite loop
            } while (
                Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) < minDistance
            );
           
            enemies.push({
                x: x,
                y: y,
                size: enemyData.size,
                speed: enemyData.speed,
                health: enemyData.health,
                maxHealth: enemyData.health,
                damage: enemyData.damage,
                color: enemyData.color,
                type: type,
                xp: enemyData.xp,
                coinDrop: enemyData.coinDrop
            });
        }
       
        // Level up
        function levelUp() {
            playerXP -= xpToNextLevel;
            playerLevel++;
            xpToNextLevel = Math.floor(xpToNextLevel * 1.5);
           
            document.getElementById('levelText').textContent = `Lvl: ${playerLevel}`;
            document.getElementById('xpBar').style.width = `${(playerXP / xpToNextLevel) * 100}%`;
           
            // Show upgrade screen
            currentGameState = GAME_STATE.UPGRADING;
            document.getElementById('upgradeScreen').classList.remove('hidden');
           
            // Generate 3 random upgrade options
            const upgradeOptions = document.getElementById('upgradeOptions');
            upgradeOptions.innerHTML = '';
           
            const availableUpgrades = Object.keys(upgrades);
            const selectedUpgrades = [];
           
            // Make sure we don't show duplicates
            while (selectedUpgrades.length < 3 && selectedUpgrades.length < availableUpgrades.length) {
                const randomIndex = Math.floor(Math.random() * availableUpgrades.length);
                const upgradeKey = availableUpgrades[randomIndex];
               
                if (!selectedUpgrades.includes(upgradeKey)) {
                    selectedUpgrades.push(upgradeKey);
                }
            }
           
            // Create upgrade cards
            for (const upgradeKey of selectedUpgrades) {
                const upgrade = upgrades[upgradeKey];
               
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <h3 class="text-lg mb-2">${upgrade.name}</h3>
                    <p class="text-sm mb-4">${upgrade.description}</p>
                    <button class="btn select-upgrade-btn" data-upgrade="${upgradeKey}">SELECT</button>
                `;
               
                upgradeOptions.appendChild(card);
            }
           
            // Add event listeners to upgrade buttons
            document.querySelectorAll('.select-upgrade-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const upgradeKey = e.target.getAttribute('data-upgrade');
                    selectUpgrade(upgradeKey);
                });
            });
        }
       
        // Select upgrade
        function selectUpgrade(upgradeKey) {
            upgrades[upgradeKey].apply();
           
            // Hide upgrade screen
            document.getElementById('upgradeScreen').classList.add('hidden');
           
            // Resume game
            currentGameState = GAME_STATE.PLAYING;
           
            // Show notification
            showNotification(`Upgrade applied: ${upgrades[upgradeKey].name}`);
        }
       
        // Update health bar
        function updateHealthBar() {
            const healthPercentage = (playerData.health / playerData.maxHealth) * 100;
            document.getElementById('healthBar').style.width = `${healthPercentage}%`;
            document.getElementById('healthText').textContent = `${Math.floor(playerData.health)}/${playerData.maxHealth}`;
           
            // Change color based on health
            if (healthPercentage < 30) {
                document.getElementById('healthBar').style.backgroundColor = '#ff0000';
            } else if (healthPercentage < 60) {
                document.getElementById('healthBar').style.backgroundColor = '#ff9900';
            } else {
                document.getElementById('healthBar').style.backgroundColor = '#4CAF50';
            }
        }
       
        // Game over
        function gameOver() {
            gameRunning = false;
            currentGameState = GAME_STATE.GAME_OVER;
           
            // Show game over screen
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalWave').textContent = currentWave;
            document.getElementById('finalEnemies').textContent = enemiesDefeated;
            document.getElementById('finalCoins').textContent = coinsCollected;
           
            // Hide HUD
            document.getElementById('gameHUD').classList.add('hidden');
        }
       
        // Initialize the game when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>

